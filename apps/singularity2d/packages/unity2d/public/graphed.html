<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Day Vault</title>
  <link href="/modules/bootstrap/bootstrap.min.css" rel="stylesheet">
  <link href="styled.css" rel="stylesheet">
  <!-- <script src="node_modules/eruda/eruda.js"></script> -->
  <!-- <script>eruda.init();</script> -->
</head>

<body>
  <main id="3d-graph"></main>
  <script src="//unpkg.com/3d-force-graph"></script>
  <script type="importmap">{ "imports": { "three": "//unpkg.com/three/build/three.module.js" }}</script>
  <script type="module">
    import SpriteText from "//unpkg.com/three-spritetext/dist/three-spritetext.mjs";
    // import { CSS2DRenderer, CSS2DObject } from '//unpkg.com/three/examples/jsm/renderers/CSS2DRenderer.js';

    const N = 300;
    const gData = {
      nodes: [...Array(N).keys()].map(i => ({ id: i })),
      links: [...Array(N).keys()]
        .filter(id => id)
        .map(id => ({
          source: id,
          target: Math.round(Math.random() * (id - 1))
        }))
    };
    const Graph = ForceGraph3D({
      controlType: 'orbit',
      // extraRenderers: [new CSS2DRenderer()]
    })
      (document.getElementById('3d-graph'))
      .jsonUrl('/get/0x234343?signature=0x974')
      .cooldownTicks(100)
      // .graphData(gData)
      .nodeId("fingerprint")
      .nodeLabel("title")
      .nodeAutoColorBy('path')
      .nodeThreeObject(node => {
        const sprite = new SpriteText(node.title);
        sprite.material.depthWrite = false; // make sprite background transparent
        sprite.color = node.color;
        sprite.textHeight = 8;
        return sprite;
      })
      // .nodeThreeObject(node => {
      //   const nodeEl = document.createElement('div');
      //   // nodeEl.textContent = node.html || node.label;
      //   nodeEl.innerHTML = node.html || node.label;
      //   nodeEl.style.color = node.color;
      //   nodeEl.className = 'node-label';
      //   return new CSS2DObject(nodeEl);
      // })
      // .nodeThreeObjectExtend(true)
      .onNodeClick(node => {
        // Aim at node from outside it
        const distance = 200;
        const distRatio = 1 + distance / Math.hypot(node.x, node.y, node.z);

        const newPos = node.x || node.y || node.z
          ? { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }
          : { x: 0, y: 0, z: distance }; // special case if node is in (0,0,0)

        Graph.cameraPosition(
          newPos, // new position
          node, // lookAt ({ x, y, z })
          3000  // ms transition duration
        );
      })
      .onNodeRightClick((node, event)=>{
        if(node.link){
          document.location = node.link
        }
      })
    // Spread nodes a little wider
    Graph.d3Force('charge').strength(-120);
    Graph.onEngineStop(() => Graph.zoomToFit(400));
  </script>
  <script src="/modules/bootstrap/bootstrap.bundle.min.js"></script>
  <!-- <script type="module" src="modules/mqtt/mqtt.esm.js"></script> -->
  <!-- <script src="./main.js"></script> -->

</html>